<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Colour Code Cracker: Hard Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="Colour Code Cracker: Hard Mode">
  <meta property="og:description" content="Crack the secret colour code in Hard Mode â€” now with an extra twist.">
  <meta property="og:image" content="https://puzzlerjoe90.github.io/colour-code-cracker/share-preview.png">
  <meta property="og:url" content="https://puzzlerjoe90.github.io/colour-code-cracker/hard-mode/">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EGCBDDKWS9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-EGCBDDKWS9');
  </script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom, #f0f8ff, #dfe9f3);
      text-align: center;
      color: #333;
    }

    h1 {
      font-size: 2.2em;
      margin-top: 20px;
      color: #d35400;
    }

    #streakDisplay {
      margin-bottom: 10px;
      font-weight: bold;
    }

    .palette {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin: 10px 0;
    }

    .palette-colour {
      width: 40px;
      height: 40px;
      margin: 5px;
      border: 2px solid #999;
      border-radius: 50%;
      cursor: pointer;
    }

    .palette-colour.selected {
      border: 4px solid #000;
    }

    .guess-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px 0;
    }

    .circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #eee;
      margin: 0 5px;
      cursor: pointer;
    }

    .circle.empty {
      border: 2px dashed #bbb;
    }

    .feedback {
      display: flex;
      margin-left: 10px;
    }

    .dot {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      margin: 2px;
    }

    .dot.correct { background: gold; }
    .dot.partial { background: black; }
    .dot.wrong { background: lightgrey; }

    #submit, #tip-btn, #share-btn, #mute-btn {
      margin: 10px;
      padding: 10px 16px;
      font-size: 1em;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      background: #d35400;
      color: white;
    }

    #submit:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #message {
      font-weight: bold;
      margin: 10px 0;
    }

    .message.success { color: green; }
    .message.failure { color: crimson; }

    #popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }

    #popup-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
    }

    #back-link {
      margin-top: 10px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h1>Colour Code Cracker: Hard Mode</h1>
  <p><a href="../index.html" id="back-link">Back to Normal Mode</a></p>
  <p id="streakDisplay"></p>
  <div class="palette" id="palette"></div>
  <div id="board"></div>

  <div>
    <button id="submit" disabled>Submit</button>
    <button id="tip-btn">Tip</button>
    <button id="share-btn" onclick="shareResult()">Share</button>
    <button id="mute-btn">ðŸ”Š</button>
  </div>

  <p id="message" class="message"></p>

  <div id="popup">
    <div id="popup-content">
      <h2 id="popup-title"></h2>
      <p id="popup-text"></p>
    </div>
  </div>

  <audio id="bg-music" src="https://cdn.pixabay.com/audio/2023/03/20/audio_eb49c96748.mp3" loop></audio>
    <script>
    const colours = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#ff1493', '#e67e22']; // + orange
    const maxAttempts = 6;
    const todayKey = new Date().toISOString().slice(0, 10);
    const seed = "ColourCodeHard" + todayKey;
    let hash = 0;
    for (let i = 0; i < seed.length; i++) {
      hash = seed.charCodeAt(i) + ((hash << 5) - hash);
    }
    let rand = hash;
    const next = () => (rand = (rand * 9301 + 49297) % 233280) / 233280;

    function generateCode() {
      let code = [];
      for (let i = 0; i < 4; i++) {
        code.push(colours[Math.floor(next() * colours.length)]);
      }
      return code;
    }

    const secretCode = generateCode();
    const board = document.getElementById("board");
    const paletteDiv = document.getElementById("palette");
    const message = document.getElementById("message");
    const submitBtn = document.getElementById("submit");
    const tipBtn = document.getElementById("tip-btn");
    const muteBtn = document.getElementById("mute-btn");
    const shareBtn = document.getElementById("share-btn");
    const bgMusic = document.getElementById("bg-music");

    let currentGuess = [];
    let guesses = [];
    let gameOver = false;
    let selectedColour = null;

    colours.forEach(c => {
      const swatch = document.createElement("div");
      swatch.className = "palette-colour";
      swatch.style.backgroundColor = c;
      swatch.onclick = () => {
        selectedColour = c;
        document.querySelectorAll('.palette-colour').forEach(p => p.classList.remove('selected'));
        swatch.classList.add('selected');
      };
      paletteDiv.appendChild(swatch);
    });

    function renderBoard() {
      board.innerHTML = '';
      for (let i = 0; i < maxAttempts; i++) {
        const row = document.createElement("div");
        row.className = "guess-row";
        const guess = guesses[i] || [];
        for (let j = 0; j < 4; j++) {
          const circle = document.createElement("div");
          circle.className = "circle";
          if (guess[j]) circle.style.backgroundColor = guess[j];
          else circle.classList.add("empty");
          circle.onclick = () => {
            if (gameOver || !selectedColour || i !== guesses.length) return;
            guess[j] = selectedColour;
            renderBoard();
            if (guess.length === 4 && guess.every(Boolean)) {
              submitBtn.disabled = false;
              currentGuess = guess;
            }
          };
          row.appendChild(circle);
        }

        const fb = feedbacks[i];
        if (fb) {
          const fbDiv = document.createElement("div");
          fbDiv.className = "feedback";
          fb.forEach(f => {
            const dot = document.createElement("div");
            dot.className = "dot " + f;
            fbDiv.appendChild(dot);
          });
          row.appendChild(fbDiv);
        }

        board.appendChild(row);
      }
    }

    let feedbacks = [];
    function getFeedback(guess) {
      const code = [...secretCode];
      const fb = [];
      const used = Array(4).fill(false);

      // First pass: correct
      guess.forEach((g, i) => {
        if (g === code[i]) {
          fb[i] = 'correct';
          code[i] = null;
          used[i] = true;
        }
      });

      // Second pass: partial
      guess.forEach((g, i) => {
        if (!fb[i]) {
          const idx = code.indexOf(g);
          if (idx !== -1) {
            fb[i] = 'partial';
            code[idx] = null;
          } else {
            fb[i] = 'wrong';
          }
        }
      });

      return fb;
    }

    function showPopup(win) {
      document.getElementById("popup").style.display = "flex";
      document.getElementById("popup-title").textContent = win ? "You Cracked It!" : "Game Over";
      document.getElementById("popup-text").textContent = win ? "Well done!" : "Better luck tomorrow.";
    }

    function handleSubmit() {
      if (gameOver || currentGuess.length !== 4) return;
      const fb = getFeedback(currentGuess);
      feedbacks.push(fb);
      guesses.push(currentGuess);
      currentGuess = [];
      renderBoard();

      if (fb.every(f => f === 'correct')) {
        showPopup(true);
        const lastWin = localStorage.getItem('ccc-hard-last-win');
        const streak = parseInt(localStorage.getItem('ccc-hard-streak')) || 0;
        const best = parseInt(localStorage.getItem('ccc-hard-best')) || 0;
        const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0,10);
        const newStreak = (lastWin === yesterday) ? streak + 1 : 1;
        localStorage.setItem('ccc-hard-streak', newStreak);
        localStorage.setItem('ccc-hard-last-win', todayKey);
        localStorage.setItem('ccc-hard-best', Math.max(best, newStreak));
        updateStreakDisplay();
        gtag('event', 'game_won', { attempts: guesses.length, mode: 'hard' });
        gameOver = true;
      } else if (guesses.length >= maxAttempts) {
        showPopup(false);
        gtag('event', 'game_lost', { mode: 'hard' });
        gameOver = true;
      }

      submitBtn.disabled = true;
    }

    function updateStreakDisplay() {
      const current = localStorage.getItem('ccc-hard-streak') || 0;
      const best = localStorage.getItem('ccc-hard-best') || 0;
      document.getElementById('streakDisplay').textContent = `ðŸ”¥ Streak: ${current} | â­ Best: ${best}`;
    }

    function shareResult() {
      let grid = feedbacks.map(row =>
        row.map(r => r === 'correct' ? 'ðŸŸ¡' : r === 'partial' ? 'âš«' : 'âšª').join('')
      ).join('\n');
      const streak = localStorage.getItem('ccc-hard-streak') || 0;
      const gameNum = Math.floor((new Date(todayKey) - new Date("2024-01-01")) / 86400000);
      const text = `Colour Code Cracker Hard #${gameNum} - ðŸ”¥ Streak: ${streak}\n${grid}`;
      navigator.clipboard.writeText(text);
      alert("Copied to clipboard!");
    }

    tipBtn.onclick = () => {
      const tipped = localStorage.getItem("ccc-hard-tip-" + todayKey);
      if (tipped) return alert("Tip already used today!");
      const randIdx = Math.floor(Math.random() * 4);
      const tip = secretCode[randIdx];
      alert("Today's code includes the colour: " + colourName(tip));
      localStorage.setItem("ccc-hard-tip-" + todayKey, "1");
      gtag('event', 'tip_used', { mode: 'hard' });
    };

    function colourName(hex) {
      const names = {
        '#e74c3c': 'Red',
        '#3498db': 'Blue',
        '#2ecc71': 'Green',
        '#f1c40f': 'Yellow',
        '#ff1493': 'Pink',
        '#e67e22': 'Orange'
      };
      return names[hex] || hex;
    }

    muteBtn.onclick = () => {
      if (bgMusic.paused) {
        bgMusic.play();
        muteBtn.textContent = "ðŸ”Š";
      } else {
        bgMusic.pause();
        muteBtn.textContent = "ðŸ”ˆ";
      }
    };

    submitBtn.onclick = handleSubmit;
    updateStreakDisplay();
    renderBoard();
    setInterval(() => {
      if (new Date().toISOString().slice(0, 10) !== todayKey) location.reload();
    }, 60000);
  </script>
</body>
</html>
